<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAADoc/CAAxPDMInterfaces.edu/CAAxPDMDRMILB.m/LocalInterfaces/CAASysDRMILB.h</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        .navigation a {
            color: #2980b9;
            text-decoration: none;
            padding: 5px 10px;
            background-color: white;
            border-radius: 3px;
            border: 1px solid #bdc3c7;
        }
        .navigation a:hover {
            background-color: #3498db;
            color: white;
        }
        .content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.4;
            overflow-x: auto;
        }
        .back-to-index {
            text-align: center;
            margin: 15px 0;
        }
        .back-to-index a {
            color: #27ae60;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>CAADoc/CAAxPDMInterfaces.edu/CAAxPDMDRMILB.m/LocalInterfaces/CAASysDRMILB.h</h1>
    </div>
    
    <div class="navigation">
        <div><a href="CAASysDRMDocument.html">‚Üê ‰∏ä‰∏ÄÈ°µ: CAASysDRMDocument.h</a></div>
        <div><a href="CAASysDRMInit.html">‰∏ã‰∏ÄÈ°µ: CAASysDRMInit.h ‚Üí</a></div>
    </div>
    
    <div class="back-to-index">
        <a href="index.html">üìÅ ËøîÂõûÁõÆÂΩï</a>
    </div>
    
    <div class="content">// COPYRIGHT DASSAULT SYSTEMES 2006
#ifndef __CAAESysDRMILB
#define __CAAESysDRMILB
//===========================================================================
//  Abstract of the class:
//  ----------------------
//
//  Data extension of the CATSysDRMDocument component and implementing 
//  the CATIUExitDRMILockBytes, CATIUExitDRMDocument and CATIUExitDRMAuthorization
//
//
//===========================================================================

// System Framework
#include &quot;CATBaseUnknown.h&quot;   //Needed to derive from CATBaseUnknown
#include &quot;CATIUExitDRMILockBytes.h&quot;
#include &quot;CATILockBytes.h&quot;


class CAASysDRMILB : public CATBaseUnknown
{
  // Used in conjunction with CATImplementClass in the .cpp file
  CATDeclareClass;

  public:

    CAASysDRMILB();
    virtual ~CAASysDRMILB();

  // ILockBytes   
/**
 * Reads and decrypts a block of datas.
 * &lt;b&gt;Role&lt;/b&gt;: Reads a block of datas in a crypted ILockBytes and returns the 
 * decrypted datas. This method is used for the manipulation of V5 documents.
 * The given offset and length are refering to the decrypted version of the 
 * file.
 * @param iOffset [in]
 *   Offset of the block in the decrypted file 
 * @param  iBuff [in]
 *  Buffer where the decrypted datas where will be writen.
 * @param iLengthToRead [i]
 *   the size of of the requested decrypted datas.
 * @param oLengthRead [out]
 *   the length of read datas.
 * @return
 *   &lt;b&gt;Legal values&lt;/b&gt;:
 *   &lt;br&gt;&lt;tt&gt; S_OK :&lt;/tt&gt;on Success.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_SEEKERROR :&lt;/tt&gt; problem in setting the read offset.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_READFAULT :&lt;/tt&gt; problem while reading.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_INVALIDPARAMETER :&lt;/tt&gt; arguments incorrects.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_DOCFILECORRUPT  :&lt;/tt&gt; document can not be decrypted.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_UNKNOWN :&lt;/tt&gt; unexpected error.
 */    
    HRESULT ReadAt( ULARGE_INTEGER iOffset,
		    void  *iBuff,
		    ULONG iLengthToRead,
		    ULONG  *oLengthRead) ; 


/**
 * Writes and crypts  a block of datas.
 * &lt;b&gt;Role&lt;/b&gt;: Writes a block of datas. This method is used for the manipulation
 * of V5 documents.
 * The given offset and length are refering to the decrypted version of the file. 
 * @param iOffset [in]
 *   Offset of the block in the decrypted file 
 * @param  iDataSource [in]
 *  Buffer of uncrypted datas to write.
 * @param iLengthToWrite [i]
 *   the size of of the datas to write.
 * @param oLengthWriten [out]
 *   the length of read writen. Should be equal to iLengthToWrite if no 
 *   problem has occurred.
 * @return
 *   &lt;b&gt;Legal values&lt;/b&gt;:
 *   &lt;br&gt;&lt;tt&gt; S_OK :&lt;/tt&gt;on Success.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_SEEKERROR :&lt;/tt&gt; problem in setting the read offset.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_WRITEFAULT :&lt;/tt&gt; problem while writing.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_MEDIUMFULL :&lt;/tt&gt; disk full error.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_INVALIDPARAMETER :&lt;/tt&gt; arguments incorrects.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_DISKISWRITEPROTECTED :&lt;/tt&gt; disk write protected.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_UNKNOWN :&lt;/tt&gt; unexpected error.
*/          
  HRESULT WriteAt( ULARGE_INTEGER iOffset,
		   const void *iDataSource,
		   ULONG iLengthToWrite,
		   ULONG  *LengthWritten) ;
        
/**
 * Flush all the buffers.
 * &lt;b&gt;Role&lt;/b&gt;: Insures that the disk view of the file is coherent, and that all
 * the  buffers have been writen on disk.
 * @return
 *   &lt;b&gt;Legal values&lt;/b&gt;:
 *   &lt;br&gt;&lt;tt&gt; S_OK :&lt;/tt&gt;on Success.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_WRITEFAULT :&lt;/tt&gt; problem while writing.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_MEDIUMFULL :&lt;/tt&gt; disk full error.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_DISKISWRITEPROTECTED :&lt;/tt&gt; disk write protected.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_UNKNOWN :&lt;/tt&gt; unexpected error.
*/          
  HRESULT  Flush( void) ;



/**
 * Sets the size of the CATILockBytes.
 * &lt;b&gt;Role&lt;/b&gt;: Sets the size of the CATILockBytes.
 * @ param iLength.
 *      The new size of the CATILockBytes.
 * @return
 *   S_OK on Success.
 *   E_FAIL on error. ( We can discuss further for more precise errors codes)
*/                  
  HRESULT SetSize( ULARGE_INTEGER iLength);
        
 /**
 * Locks a region of the CATILockBytes.
 * &lt;b&gt;Role&lt;/b&gt;: Locks a region of the CATILockBytes. Not used.
 * The implementation can return CATSysCLB_E_UNIMPLEMENTEDFUNCTION
 * @param iOffset [in]
 *   Offset of the block in the decrypted file  
 * @param iLength [i] 
 *   the size of the region. 
 * @param dwLockType [in] 
 *        type of lock. 
 * @return 
 *   &lt;b&gt;Legal values&lt;/b&gt;: 
 *   &lt;br&gt;&lt;tt&gt; S_OK :&lt;/tt&gt;on Success. 
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_UNIMPLEMENTEDFUNCTION :&lt;/tt&gt; unimplemented       
*/               
  HRESULT LockRegion( ULARGE_INTEGER iOffset, 
		      ULARGE_INTEGER iLegnth,
		      DWORD dwLockType); 
 /**
 * Unocks a region of the CATILockBytes.
 * &lt;b&gt;Role&lt;/b&gt;: Unlocks a region of the CATILockBytes. Not used.
 * The implementation can return CATSysCLB_E_UNIMPLEMENTEDFUNCTION
 * @param iOffset [in]
 *   Offset of the block in the decrypted file 
 * @param iLength [i]
 *   the size of the region.
 * @param dwLockType [in]
 *        type of lock.
 * @return
 *   &lt;b&gt;Legal values&lt;/b&gt;:
 *   &lt;br&gt;&lt;tt&gt; S_OK :&lt;/tt&gt;on Success.
 *   &lt;br&gt;&lt;tt&gt; CATSysCLB_E_UNIMPLEMENTEDFUNCTION :&lt;/tt&gt; unimplemented
*/                
 HRESULT  UnlockRegion( ULARGE_INTEGER iOffset,
			ULARGE_INTEGER iLength,
			DWORD dwLockType) ;
/**
 * Returns informations for the given file.
 * &lt;b&gt;Role&lt;/b&gt;:  Returns informations for the given file. For the size, 
 * the uncrypted size must be returned.
 * @return
 *   S_OK on Success.
 *   E_FAIL on error. ( We can discuss further for more precise errors codes)
*/          
  HRESULT  Stat( STATSTG FAR *oStat, DWORD iStatFlag);


  // CATIUExitDRMILockBytes
  HRESULT  OpenOnILockBytes ( CATILockBytes *iILB);

  HRESULT Close();



 private:
  
  // Copy constructor, not implemented
  // Set as private to prevent from compiler automatic creation as public.
  CAASysDRMILB(const CAASysDRMILB &amp;iObjectToCopy);
  
  // Assignment operator, not implemented
  // Set as private to prevent from compiler automatic creation as public.
  CAASysDRMILB &amp; operator = (const CAASysDRMILB &amp;iObjectToCopy);

  HRESULT FlushCurBck();
  HRESULT ReadCurBck(size_t &amp;oRead);

  
  // Block Size for the encryption algorithm
  static size_t _Size;
  // Statistics of the file
  STATSTG _Stat;
  // memory buffer
  char * _Buff;
  // Space really used in the buffer ( usefull for the last block of the file)
  size_t _Used;
  // Current position in the memory buffer
  size_t  _CurPos;
  // Offset of the begining of the Buffer in the file 
  ULARGE_INTEGER _Offset;
  // Physical file offset needed for avoiding too many seeks
  ULARGE_INTEGER _FileOffset; 
  // Physical size of the document for padding purpose
  ULARGE_INTEGER _FileSize;
  // flags
  int _State;
  // ILockBytes
  CATILockBytes *_ILB;

  // current symetric key
  unsigned char *_key;
  // size of the key
  size_t _KeySize;

};
#endif
</div>
    
    <div class="navigation">
        <div><a href="CAASysDRMDocument.html">‚Üê ‰∏ä‰∏ÄÈ°µ: CAASysDRMDocument.h</a></div>
        <div><a href="CAASysDRMInit.html">‰∏ã‰∏ÄÈ°µ: CAASysDRMInit.h ‚Üí</a></div>
    </div>
</body>
</html>